<a class="brand" href="/">
  <img class="link-logo" src="{{ relURL "brand.svg" }}" alt="Mastodon" />
</a>

<ul>
  {{ $currentPage := . }}
  <button class="toggle-button"><strong>+</strong><span>Expand All</span></button>
  {{ range .Site.Menus.docs.ByWeight }}
    <li class="{{ if .Page }}collapsed stay-collapsed{{ end }}">
      {{ if .Page }}
        <a href="{{ .URL }}" class="{{ if $currentPage.IsMenuCurrent "docs" . }}active{{ end }}">{{ .Name }}</a>
      {{ else }}
        <span class="sub-title">{{ .Name }}</span>
      {{ end }}

      {{ if .HasChildren }}
        <ul class="sub-menu" id="sidebar-{{ anchorize .Name }}">
          {{ range .Children }}
            <li>
              <a href="{{ .URL }}" class="{{ if $currentPage.IsMenuCurrent "docs" . }}active{{ end }}">{{ .Name }}</a>

              {{ if .HasChildren }}
                <ul class="sub-menu">
                  {{ range .Children }}
                    <li>
                      <a href="{{ .URL }}" class="{{ if $currentPage.IsMenuCurrent "docs" . }}active{{ end }}">{{ .Name }}</a>
                    </li>
                  {{ end }}
                </ul>
              {{ end }}
            </li>
          {{ end }}
        </ul>
      {{ end }}
    </li>
  {{ end }}
</ul>

<script>
  document.documentElement.classList.add('js');
  for (const header of document.querySelectorAll('.sidebar .sub-title')) {
    header.role = 'button';
    header.tabIndex = 0;
    header.ariaExpanded = true;
    header.ariaControlsElement = header.nextElementSibling;
    const toggle = () => {
      header.nextElementSibling.classList.toggle('collapsed');
      const collapsed = header.nextElementSibling.classList.contains('collapsed')
      header.ariaExpanded = !collapsed;
      header.parentNode.classList.toggle('collapsed', collapsed);
    }
    header.addEventListener('click', toggle);
    header.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === 'Space' || e.key === ' ') {
        toggle();
        e.preventDefault();
      }
    });
    if (!header.nextElementSibling.querySelector('.active')) {
      toggle()
    }
  }
  const toggle = document.querySelector('.sidebar .toggle-button')
  toggle.addEventListener('click', () => {
    const collapsed = document.querySelectorAll('.sidebar li.collapsed:not(.stay-collapsed)')
    if (collapsed.length) {
      for (const collapsible of collapsed) {
        collapsible.querySelector('.sub-title').click();
      }
      toggle.querySelector('strong').textContent = '\u2212' // minus sign
      toggle.querySelector('span').textContent = 'Collapse All'
    } else {
      for (const collapsible of document.querySelectorAll('.sidebar > ul > li:not(.stay-collapsed)')) {
        collapsible.querySelector('.sub-title').click();
      }
      toggle.querySelector('strong').textContent = '+'
      toggle.querySelector('span').textContent = 'Expand All'
    }
  })
</script>
